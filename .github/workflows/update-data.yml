name: Update Production Data

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      update_reason:
        description: 'GÃ¼ncelleme nedeni'
        required: false
        default: 'Manuel gÃ¼ncelleme'
  
  schedule:
    - cron: '0 */6 * * *'

jobs:
  update-data:
    runs-on: ubuntu-latest
    name: Veri GÃ¼ncelleme Ä°ÅŸi
    
    steps:
    - name: Repository'yi Ä°ndir
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Mevcut ZamanÄ± Al
      id: timestamp
      run: |
        echo "current_time=$(date +'%d.%m.%Y %H:%M')" >> $GITHUB_OUTPUT
        echo "iso_time=$(date -u +"%Y-%m-%dT%H:%M:%S")" >> $GITHUB_OUTPUT
    
    - name: Test Verisi GÃ¼ncelle
      run: |
        # Yeni JSON verisini oluÅŸtur
        cat > data.json << 'EOF'
        {
          "data": [
            {
              "Ãœretim HaftasÄ±": "51",
              "CRMOrderNo": "AUTO-1216",
              "KullanÄ±m": "Mutfak",
              "MaÄŸaza": "Migros",
              "MÃ¼ÅŸteri": "Otomatik Test Åžirketi",
              "ModÃ¼l Adet": "25",
              "Ãœreticiye AktarÄ±m Tarihi": "16.12.2024",
              "Kapak Prg": "Evet",
              "TamamlayÄ±cÄ± Prg": "HayÄ±r",
              "GÃ¶vde Rengi": "Beyaz",
              "Teslim AlÄ±ndÄ± mÄ±?": "HayÄ±r",
              "Lake GidiÅŸ": "17.12.2024",
              "Lake Termin": "21.12.2024",
              "Lake DÃ¶nÃ¼ÅŸ": "23.12.2024",
              "Ä°ndex": "AUTO-1",
              "E/L": "E",
              "Proje TÃ¼rÃ¼": "Otomatik Test"
            },
            {
              "Ãœretim HaftasÄ±": "51",
              "CRMOrderNo": "AUTO-1216-2",
              "KullanÄ±m": "Banyo",
              "MaÄŸaza": "Carrefour", 
              "MÃ¼ÅŸteri": "Test A.Åž.",
              "ModÃ¼l Adet": "15",
              "Ãœreticiye AktarÄ±m Tarihi": "16.12.2024",
              "Kapak Prg": "HayÄ±r",
              "TamamlayÄ±cÄ± Prg": "Evet",
              "GÃ¶vde Rengi": "Gri",
              "Teslim AlÄ±ndÄ± mÄ±?": "HayÄ±r", 
              "Lake GidiÅŸ": "18.12.2024",
              "Lake Termin": "22.12.2024",
              "Lake DÃ¶nÃ¼ÅŸ": "24.12.2024",
              "Ä°ndex": "AUTO-2",
              "E/L": "L",
              "Proje TÃ¼rÃ¼": "Test Premium"
            }
          ],
          "columns": ["Ãœretim HaftasÄ±", "CRMOrderNo", "KullanÄ±m", "MaÄŸaza", "MÃ¼ÅŸteri", "ModÃ¼l Adet", "Ãœreticiye AktarÄ±m Tarihi", "Kapak Prg", "TamamlayÄ±cÄ± Prg", "GÃ¶vde Rengi", "Teslim AlÄ±ndÄ± mÄ±?", "Lake GidiÅŸ", "Lake Termin", "Lake DÃ¶nÃ¼ÅŸ", "Ä°ndex", "E/L", "Proje TÃ¼rÃ¼"],
          "total_rows": 2,
          "original_rows": 2,
          "filtered_rows": 0,
          "last_updated": "CURRENT_TIME_PLACEHOLDER",
          "missing_columns": [],
          "auto_updated": true,
          "update_source": "GitHub Actions"
        }
        EOF
        
        # ZamanÄ± gÃ¼ncelle
        sed -i "s/CURRENT_TIME_PLACEHOLDER/${{ steps.timestamp.outputs.iso_time }}/g" data.json
        
        echo "âœ… data.json gÃ¼ncellendi: $(date +'%d.%m.%Y %H:%M')"
        echo "ðŸ“„ Dosya boyutu: $(wc -c < data.json) bytes"
    
    - name: DeÄŸiÅŸiklikleri Commit Et
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions Bot ðŸ¤–"
        git add data.json
        
        if git diff --staged --quiet; then
          echo "DeÄŸiÅŸiklik yok, commit atlanÄ±yor"
        else
          git commit -m "ðŸ¤– Otomatik veri gÃ¼ncelleme - ${{ steps.timestamp.outputs.current_time }}"
          git push origin main
          echo "âœ… DeÄŸiÅŸiklikler GitHub'a gÃ¶nderildi"
        fi
    
    - name: GÃ¼ncelleme Ã–zeti
      run: |
        echo "## ðŸ“Š GÃ¼ncelleme Raporu" >> $GITHUB_STEP_SUMMARY
        echo "- **Zaman:** ${{ steps.timestamp.outputs.current_time }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Durum:** âœ… BaÅŸarÄ±lÄ±" >> $GITHUB_STEP_SUMMARY
        echo "- **GÃ¼ncellenen Dosya:** data.json" >> $GITHUB_STEP_SUMMARY
        echo "- **Site URL:** https://denizozarikan93.github.io/uretimplan" >> $GITHUB_STEP_SUMMARY
        echo "- **Dosya Boyutu:** $(wc -c < data.json) bytes" >> $GITHUB_STEP_SUMMARY
